###ä¸»æµæ¶ˆæ¯ä¸­é—´ä»¶ä»‹ç»
#### ActiveMQ
ActiveMQæ˜¯Apacheå‡ºå“ï¼Œæœ€æµè¡Œçš„ï¼Œèƒ½åŠ›å¼ºåŠ²çš„å¼€æºæ¶ˆæ¯æ€»çº¿ï¼Œå¹¶ä¸”ä»–æ˜¯ä¸€ä¸ªå®Œå…¨æ”¯æŒJMSè§„èŒƒçš„æ¶ˆæ¯ä¸­é—´ä»¶ã€‚å…¶ä¸°å¯Œçš„APIã€å¤šç§é›†ç¾¤æ„å»ºæ¨¡å¼ä½¿å¾—ä»–æˆä¸ºä¸šç•Œè€ç‰Œæ¶ˆæ¯ä¸­é—´ä»¶ï¼Œåœ¨ä¸­å°å‹ä¼ä¸šä¸­åº”ç”¨å¹¿æ³›ï¼
MQè¡¡é‡æŒ‡æ ‡ï¼šæœåŠ¡æ€§èƒ½ã€æ•°æ®å­˜å‚¨ã€é›†ç¾¤æ¶æ„
é€æ¸åœ¨è¢«æ–°å‹æ¶ˆæ¯ä¸­é—´ä»¶æ›¿ä»£ï¼Œå¦‚æœä¸æ˜¯ç‰¹åˆ«å¤§çš„å¹¶å‘åœºæ™¯ï¼ŒActiveæ¨¡å¼ä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚å…¶æ¶æ„å¦‚ä¸‹ï¼š
![(..picture/rabbitmq/rabbitmq4.png)
#### Kafka
Kafkaæ˜¯Linkedlnå¼€æºåˆ†å¸ƒå¼å‘å¸ƒ-è®¢é˜…æ¶ˆæ¯ç³»ç»Ÿï¼Œç›®å‰å½’å±äºApacheé¡¶çº§é¡¹ç›®ã€‚Kafkaä¸»è¦ç‰¹ç‚¹æ˜¯åŸºäºPullæ¨¡å¼æ¥å¤„ç†æ¶ˆæ¯æ¶ˆè´¹ï¼Œè¿½æ±‚é«˜ååé‡ï¼Œä¸€å¼€å§‹å°±æ˜¯ä¸ºå¤§æ•°æ®è®¾è®¡ï¼Œçš„ç›®çš„å°±æ˜¯ç”¨äºæ—¥å¿—æ”¶é›†å’Œä¼ è¾“ã€‚0.8ç‰ˆæœ¬å¼€å§‹æ”¯æŒå¤åˆ¶ï¼Œä¸æ”¯æŒäº‹åŠ¡ï¼Œå¯¹æ¶ˆæ¯çš„é‡å¤ã€ä¸¢å¤±ã€é”™è¯¯æ²¡æœ‰ä¸¥æ ¼è¦æ±‚ï¼ŒåŸºäºå†…å­˜ï¼Œé€‚åˆäº§ç”Ÿå¤§é‡æ•°æ®çš„äº’è”ç½‘æœåŠ¡çš„æ•°æ®æ”¶é›†ä¸šåŠ¡ã€‚é›†ç¾¤æ¶æ„å¦‚ä¸‹ï¼š
![(..picture/rabbitmq/rabbitmq5.png)
####RocketMQ
RocketMQæ˜¯é˜¿é‡Œå¼€æºçš„æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œç›®å‰ä¹Ÿæ˜¯Apacheçš„é¡¶çº§é¡¹ç›®ï¼Œçº¯Javaå¼€å‘ï¼Œå…·æœ‰é«˜ååé‡ã€é«˜å¯ç”¨æ€§ã€é€‚åˆå¤§è§„æ¨¡åˆ†å¸ƒå¼ç³»ç»Ÿåº”ç”¨çš„ç‰¹ç‚¹ã€‚RocketMQæ€è·¯èµ·æºäºKafkaï¼Œå®ƒå¯¹æ¶ˆæ¯çš„å¯é æ€§ä¼ è¾“åŠäº‹åŠ¡æ€§åšäº†ä¼˜åŒ–ï¼Œç›®å‰åœ¨é˜¿é‡Œé›†å›¢è¢«å¹¿æ³›åº”ç”¨äºäº¤æ˜“ã€å……å€¼ã€æµè®¡ç®—ã€æ¶ˆæ¯æ¨é€ã€æ—¥å¿—æµå¼å¤„ç†ã€binglogåˆ†å‘ç­‰åœºæ™¯ã€‚ä¿è¯æ¶ˆæ¯é˜Ÿåˆ—çš„é¡ºåºæ€§ï¼Œé›†ç¾¤æ¶æ„å¤šç»´ï¼ˆ1-1,1-n,n-nï¼‰,ç»´æŠ¤å›°éš¾ï¼Œå•†ä¸šç‰ˆæ”¶è´¹ã€‚åŠæ¶æ„å¦‚ä¸‹ï¼š
![(..picture/rabbitmq/rabbitmq6.png)
### RabbitMQ
#### RabbitMQç®€ä»‹
RabbitMQæ˜¯ä¸€ä¸ªå¼€æºçš„æ¶ˆæ¯ä»£ç†å’Œé˜Ÿåˆ—æœåŠ¡å™¨ï¼Œç”¨æ¥é€šè¿‡æ™®é€šåè®®åœ¨å®Œå…¨ä¸åŒçš„åº”ç”¨ä¹‹é—´å…±äº«æ•°æ®ï¼ŒRabbitMQæ˜¯ä½¿ç”¨Erlangè¯­è¨€æ¥ç¼–å†™çš„ï¼Œå¹¶ä¸”RabbitMQæ˜¯åŸºäºAMQPåè®®çš„ã€‚
1.å¼€æºã€æ€§èƒ½ä¼˜ç§€ã€ç¨³å®šæ€§ä¿éšœã€æä¾›å¯é æ€§æŠ•é€’æ¨¡å¼ã€è¿”å›æ¨¡å¼
2.ä¸springAMQPå®Œç¾çš„æ•´åˆï¼ŒAPIä¸°å¯Œ
3.é›†ç¾¤æ¨¡å¼ä¸°å¯Œï¼Œæ”¯æŒè¡¨è¾¾å¼çš„é…ç½®ï¼ŒHAæ¨¡å¼ï¼Œé•œåƒé˜Ÿåˆ—æ¨¡å¼
4.ä¿è¯æ•°æ®ä¸ä¸¢å¤±çš„å‰æä¸‹åšåˆ°é«˜å¯é æ€§
AMQPé«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼š
AMQPå®šä¹‰ï¼šæ˜¯å…·æœ‰ç°ä»£ç‰¹å¾çš„äºŒè¿›åˆ¶åè®®ã€‚æ˜¯ä¸€ä¸ªæä¾›ç»Ÿä¸€æ¶ˆæ¯æœåŠ¡çš„åº”ç”¨å±‚æ ‡å‡†é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼Œæ˜¯åº”ç”¨å±‚åè®®çš„ä¸€ä¸ªå¼€æ”¾æ ‡å‡†ï¼Œä¸ºé¢å‘æ¶ˆæ¯çš„ä¸­é—´ä»¶è®¾è®¡ã€‚åè®®æ¨¡å‹å¦‚ä¸‹å›¾ï¼š![](..picture/rabbitmq/rabbitmq1.png)
AMQPçš„ä¸»è¦ç‰¹å¾æ˜¯é¢å‘æ¶ˆæ¯ã€é˜Ÿåˆ—ã€è·¯ç”±ï¼ˆåŒ…æ‹¬ç‚¹å¯¹ç‚¹å’Œå‘å¸ƒ/è®¢é˜…ï¼‰ã€å¯é æ€§ã€å®‰å…¨ï¼Œæ›´å¤šç”¨åœ¨ä¼ä¸šç³»ç»Ÿå†…ï¼Œå¯¹æ•°æ®ä¸€è‡´æ€§ï¼Œç¨³å®šæ€§å’Œå¯é æ€§è¦æ±‚å¾ˆé«˜çš„åœºæ™¯ï¼Œå¯¹æ€§èƒ½å’Œååé‡çš„è¦æ±‚è¿˜åœ¨å…¶æ¬¡ã€‚
AMQPæ ¸å¿ƒæ¦‚å¿µï¼š
1.==Server==ï¼šåˆç§°Brokerï¼Œæ¥å—å®¢æˆ·ç«¯çš„é“¾æ¥ï¼Œå®ç°AMQPå®ä½“æœåŠ¡
2.==Connection==ï¼šè¿æ¥ï¼Œåº”ç”¨ç¨‹åºä¸Brokerçš„ç½‘ç»œè¿æ¥
3.==Channel==ï¼šç½‘ç»œä¿¡é“ï¼Œå‡ ä¹æ‰€æœ‰çš„æ“ä½œéƒ½åœ¨Channelä¸­è¿›è¡Œï¼ŒChannelæ˜¯è¿›è¡Œæ¶ˆæ¯è¯»å†™çš„é€šé“ï¼Œå®¢æˆ·ç«¯å¯ä»¥å»ºç«‹å¤šä¸ªChannelï¼Œæ¯ä¸ªChannelä»£è¡¨ä¸€ä¸ªä¼šè¯ä»»åŠ¡ã€‚
4.==Message==ï¼šæ¶ˆæ¯ï¼ŒæœåŠ¡å™¨å’Œåº”ç”¨ç¨‹åºä¹‹é—´ä¼ é€çš„æ•°æ®ï¼Œç”±Propertieså’ŒBodyç»„æˆã€‚Propertieså¯ä»¥å¯¹æ¶ˆæ¯è¿›è¡Œä¿®é¥°ï¼Œæ¯”å¦‚æ¶ˆæ¯çš„ä¼˜å…ˆçº§ã€å»¶è¿Ÿç­‰é«˜çº§ç‰¹æ€§ï¼›Bodyåˆ™å°±æ˜¯æ¶ˆæ¯ä½“å†…å®¹ã€‚
5.==Virtual Host==ï¼šè™šæ‹Ÿåœ°å€ï¼Œç”¨äºè¿›è¡Œé€»è¾‘éš”ç¦»ï¼Œæœ€ä¸Šå±‚çš„æ¶ˆæ¯è·¯ç”±ã€‚ä¸€ä¸ªVirtual Hosté‡Œé¢å¯ä»¥æœ‰è‹¥å¹²ä¸ªExchangeæˆ–Queueï¼ŒåŒä¸€ä¸ªVirtual Hosté‡Œé¢ä¸èƒ½æœ‰ç›¸åŒåè½¦çš„Exchangeæˆ–Queue
6.==Exchange==ï¼šäº¤æ¢æœºï¼Œæ¥æ”¶æ¶ˆæ¯ï¼Œæ ¹æ®è·¯ç”±é”®è½¬å‘æ¶ˆæ¯åˆ°ç»‘å®šçš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚
7.==Binding==:Exchangeå’ŒQueueè´¨æ£€çš„è™šæ‹Ÿè¿æ¥ï¼Œbindingä¸­å¯ä»¥åŒ…å«routing key
8.==Routing key==ï¼šä¸€ä¸ªè·¯ç”±è§„åˆ™ï¼Œè™šæ‹Ÿæœºå¯ç”¨ä»–æ¥ç¡®å®šå¦‚ä½•è·¯ç”±ä¸€ä¸ªç‰¹å®šæ¶ˆæ¯ã€‚
9.==Queue==ï¼šä¹Ÿç§°ä¸ºMessage Queueï¼Œæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¿å­˜ä¿¡æ¯å¹¶å°†ä»–ä»¬è½¬å‘ç»™æ¶ˆè´¹è€…ã€‚
#### RabbitMQæ•´ä½“æ¶æ„
RabbitMQæ•´ä½“æ¶æ„å¦‚ä¸‹å›¾ï¼š![](..picture/rabbitmq/rabbitmq2.png)

RabbitMQæ¶ˆæ¯æµè½¬å›¾å¦‚ä¸‹å›¾ï¼š![](..picture/rabbitmq/rabbitmq3.png)

RabbitMQè´Ÿè½½å‡è¡¡é›†ç¾¤å¦‚ä¸‹å›¾ï¼š![](..picture/rabbitmq/rabbitmq7.png)
####å®‰è£…å¯åŠ¨RabbitMQ
1.å®‰è£…ï¼š
åœ¨Macä¸‹æ‰§è¡Œ`brew install rabbitmq`ï¼Œä¼šè‡ªåŠ¨å®‰è£…rabbitmqå’Œä¾èµ–çš„erlangè¯­è¨€ã€‚
```
==> Installing rabbitmq dependency: erlang
==> Downloading https://homebrew.bintray.com/bottles/erlang-21.2.4.high_sierra.b
######################################################################## 100.0%
==> Pouring erlang-21.2.4.high_sierra.bottle.tar.gz
==> Caveats
Man pages can be found in:
  /usr/local/opt/erlang/lib/erlang/man

Access them with `erl -man`, or add this directory to MANPATH.
==> Summary
ğŸº  /usr/local/Cellar/erlang/21.2.4: 5,684 files, 272.5MB
==> Installing rabbitmq
==> Downloading https://github.com/rabbitmq/rabbitmq-server/releases/download/v3
==> Downloading from https://github-production-release-asset-2e65be.s3.amazonaws
######################################################################## 100.0%
==> /usr/bin/unzip -qq -j /usr/local/Cellar/rabbitmq/3.7.11/plugins/rabbitmq_man
==> Caveats

```
2.é…ç½®ç¯å¢ƒå˜é‡ï¼š
æ‰§è¡Œï¼š`export PATH=$PATH:/usr/local/sbin`
3.å¯åŠ¨rabbitmqï¼š
åå°å¯åŠ¨æœåŠ¡ï¼š`rabbitmq-server`
åœæ­¢æœåŠ¡ï¼š`rabbitmqctl stop`
åœ¨æµè§ˆå™¨çª—å£æ‰“å¼€Â·ip:15672(é»˜è®¤ç«¯å£)`![](..picture/rabbitmq/rabbitmq8.png)
4.å¸¸ç”¨å‘½ä»¤è¡Œæ“ä½œï¼š
1.`rabbit-server`ï¼šå¯åŠ¨æœåŠ¡
2.`rabbitmqctl stop`å¯åŠ¨æœåŠ¡
3.`rabbitmqctl add_user username password`:æ·»åŠ ç”¨æˆ·
4.`rabbitmqctl list_users`:åˆ—å‡ºæ‰€æœ‰ç”¨æˆ·
5.`rabbitmqctl delete_user username`:åˆ é™¤ç”¨æˆ·
6.`rabbitmqctl clear_permissions -p vhostpath username`:æ¸…é™¤ç”¨æˆ·æƒé™
7.`rabbitmqctl list_user_permissions username`:åˆ—å‡ºç”¨æˆ·æƒé™
8.`rabbitmqctl change_password  username newpassword`:ä¿®æ”¹å¯†ç 
9.`rabbitmqctl set_permission -p vhostpath username ".*" ".*" ".*"`:è®¾ç½®ç”¨æˆ·æƒé™
10.`rabbitmqctl add_vhost vhostpath`:åˆ›å»ºè™šæ‹Ÿä¸»æœº
11.`rabbitmqctl list_vhost`:åˆ—å‡ºæ‰€æœ‰è™šæ‹Ÿä¸»æœº
12.`rabbitmqctl list_permission -p vhostpath`:åˆ—å‡ºè™šæ‹Ÿæœºä¸»æœºä¸Šçš„æ‰€æœ‰æƒé™
13.`rabbitmqctl delete_vhost vhostpath`:åˆ é™¤è™šæ‹Ÿä¸»æœº
14.`rabbitmqctl list_queues`:æŸ¥çœ‹æ‰€æœ‰é˜Ÿåˆ—ä¿¡æ¯
15.`rabbitmqctl -p vhostpath purge_queue blue`:æ¸…é™¤é˜Ÿåˆ—é‡Œçš„æ¶ˆæ¯
16.`rabbitmq reset`:æ¸…é™¤æ‰€æœ‰æ•°æ®ï¼Œåœ¨åœæ­¢æœåŠ¡åæ‰èƒ½æ‰§è¡Œ
17.`rabbitmqctl join_cluster <clusternode> [---ram]`:ç»„æˆé›†ç¾¤å‘½ä»¤
18.`rabbitmqctl cluster_status`:æŸ¥çœ‹é›†ç¾¤çŠ¶æ€
19.`rabbitmqctl change_cluster_node_type disc | ram`:ä¿®æ”¹é›†ç¾¤èŠ‚ç‚¹çš„å­˜å‚¨å½¢å¼
20.`rabbitmqctl forget_cluster_node [--offline]`:å¿˜è®°èŠ‚ç‚¹ï¼ˆæ‘˜é™¤èŠ‚ç‚¹ï¼‰
21.`rabbitmqctl rename_cluster_node oldnode1 newnode1 [oldnode2] [newnode2...]ï¼ˆä¿®æ”¹èŠ‚ç‚¹åç§°ï¼‰
### rabbitmqé€šè¿‡Pythonå®ç°
#### part1 simple demo
##### send.py
ï¼[](http://www.rabbitmq.com/img/tutorials/sending.png)
```
import pika

# å»ºç«‹ä¸RabbitMQæœåŠ¡å™¨çš„è¿æ¥
connection = pika.BlockingConnection(pika.ConnectionParameters('localhost'))
channel = connection.channel()

#åœ¨RabbitMQä¸­ï¼Œæ¶ˆæ¯æ°¸è¿œä¸èƒ½ç›´æ¥å‘é€åˆ°é˜Ÿåˆ—ï¼Œè€Œæ˜¯å…ˆé€šè¿‡äº¤æ¢æœº,æˆ‘ä»¬åœ¨è¿™ä½¿ç”¨ä¸€ç§ç”±ç©ºå­—ç¬¦ä¸²æ ‡è¯†çš„é»˜è®¤äº¤æ¢ï¼ˆå…è®¸å‡†ç¡®åœ°æŒ‡å®šæ¶ˆæ¯åº”è¯¥å»å“ªä¸ªé˜Ÿåˆ—ï¼Œéœ€è¦åœ¨`routing_key`ä¸­æŒ‡å®šé˜Ÿåˆ—åç§°ï¼‰
channel.basic_publish(exchange='',routing_key='hello',body='Hello Worldï¼')
print(" [x] Sent 'Hello World!'")
# åœ¨é€€å‡ºç¨‹åºä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿åˆ·æ–°ç½‘ç»œç¼“å†²åŒºå¹¶ä¸”æˆ‘ä»¬çš„æ¶ˆæ¯å®é™…ä¸Šå·²ä¼ é€’ç»™RabbitMQã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è½»è½»å…³é—­è¿æ¥æ¥å®ç°
connection.close()
```
##### receive.py
![](http://www.rabbitmq.com/img/tutorials/receiving.png)
```
import pika

connection = pika.BlockingConnection(pika.ConnectionParameters(host='localhost'))
channel = connection.channel()

channel.queue_declare(queue='hello')


def callback(ch, method, properties, body):
    print(" [x] Received %r" % body)


channel.basic_consume(callback,
                      queue='hello',
                      no_ack=True)

print(' [*] Waiting for messages. To exit press CTRL+C')
channel.start_consuming() # å¯åŠ¨æ— é™å¾ªç¯çš„ç›‘å¬

```
Part1ç®€å•è¯´æ˜äº†å¦‚ä½•å‘é€åŠæ¥å—æ¶ˆæ¯ã€‚æ‰§è¡Œ==receive.py==åå¯ä»¥çœ‹åˆ°ï¼š`[*] Waiting for messages. To exit press CTRL+C`ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬çš„RabbitMQå·²ç»å¼€å§‹ç›‘å¬æ¶ˆæ¯ã€‚æ­¤æ—¶æ‰§è¡Œ==send.py==å‘é€æ¶ˆæ¯åå¯ä»¥åœ¨å±å¹•ä¸Šçœ‹åˆ°` [*] Waiting for messages. To exit press CTRL+C
[x] Received b'Hello World\xef\xbc\x81'`
åœ¨ç»ˆç«¯ä¸ŠæŸ¥çœ‹é˜Ÿåˆ—ï¼š
xiangxianzhangdeMacBook-Pro:sbin xiangxianzhang$ rabbitmqctl list_queues
Timeout: 60.0 seconds ...
Listing queues for vhost / ...
name	messages
hello	0```

```

#### part2 Work Queues
![](http://www.rabbitmq.com/img/tutorials/python-two.png)
åœ¨è¿™èŠ‚ä¸­ï¼Œæˆ‘å°†å‘é€ä»£è¡¨å¤æ‚ä»»åŠ¡çš„å­—ç¬¦ä¸²ï¼Œæˆ‘é€šè¿‡`time.sleep()`æ¥ä¼ªé€ è€—æ—¶ä»»åŠ¡ã€‚
##### new_task.py
ç¨å¾®ä¿®æ”¹part1çš„send.pyï¼Œä»¥å…è®¸ä»å‘½ä»¤è¡Œå‘é€ä»»æ„æ¶ˆæ¯ã€‚
```
import sys

message = ' '.join(sys.argv[1:]) or "Hello World!"
channel.basic_publish(exchange='',
                      routing_key='hello',
                      body=message)
print(" [x] Sent %r" % message)
```
##### work.py
ä¿®æ”¹part1çš„receive.pyï¼Œä¸ºæ¶ˆæ¯ä½“ä¸­çš„æ¯ä¸ªç‚¹ä¼ªé€ 1sçš„è€—æ—¶ï¼Œå®ƒå°†ä»é˜Ÿåˆ—ä¸­å¼¹å‡ºæ¶ˆæ¯å¹¶æ‰§è¡Œä»»åŠ¡ã€‚
```
import time

def callback(ch, method, properties, body):
    print(" [x] Received %r" % body)
    time.sleep(body.count(b'.'))
    print(" [x] Done")
```
##### å¾ªç¯è°ƒåº¦
ä½¿ç”¨ä»»åŠ¡é˜Ÿåˆ—çš„ä¸€ä¸ªå¥½å¤„å°±æ˜¯ä»–å¯ä»¥==å¹¶è¡Œ==åœ°å¤„ç†æ¶ˆæ¯ã€‚å¦‚æœæˆ‘ä»¬çš„æ¶ˆæ¯å¾ˆå¤šï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æ·»åŠ æ›´è¿‡çš„workerã€‚ä¸‹é¢æˆ‘ä»¬å°†å°è¯•åŒæ—¶è¿è¡Œä¸¤ä¸ªworkerï¼Œä»–ä»¬éƒ½ä¼šä»é˜Ÿåˆ—ä¸­è·å–æ¶ˆæ¯ã€‚
å…ˆå‘é€äº”æ¡æ¶ˆæ¯ï¼š
```
xiangxianzhangdeMacBook-Pro:test xiangxianzhang$ python3 new_task.py 
 [x] Sent 'Hello World!'
xiangxianzhangdeMacBook-Pro:test xiangxianzhang$ python new_task.py First message.
 [x] Sent 'First message.'
xiangxianzhangdeMacBook-Pro:test xiangxianzhang$ python new_task.py Second message..
 [x] Sent 'Second message..'
xiangxianzhangdeMacBook-Pro:test xiangxianzhang$ python new_task.py Third message...
 [x] Sent 'Third message...'
xiangxianzhangdeMacBook-Pro:test xiangxianzhang$ python new_task.py Fourth message....
 [x] Sent 'Fourth message....'
xiangxianzhangdeMacBook-Pro:test xiangxianzhang$ python new_task.py Fifth message.....
 [x] Sent 'Fifth message.....'

```
ä¸‹é¢çœ‹ä¸¤ä¸ªworkeræ˜¯å¦‚ä½•æ¥æ”¶æ¶ˆæ¯çš„
Worker1ï¼š
```
 [*] Waiting for messages. To exit press CTRL+C
 [x] Received b'Second message..'
 [x] Done
 [x] Received b'Fourth message....'
 [x] Done

```
Worker2:
```
 [*] Waiting for messages. To exit press CTRL+C
 [x] Received b'First message.'
 [x] Done
 [x] Received b'Third message...'
 [x] Done
 [x] Received b'Fifth message.....'
 [x] Done
```
é»˜è®¤æƒ…å†µä¸‹ï¼ŒRabbitMQä¼šæŒ‰é¡ºåºå°†æ¯æ¡æ¶ˆæ¯å‘é€ç»™ä¸‹ä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œå¹³å‡è€Œè¨€ï¼Œæ¯ä¸ªæ¶ˆè´¹è€…å°†è·å¾—ç›¸åŒæ•°é‡çš„æ¶ˆæ¯ã€‚è¿™ç§åˆ†å‘æ¶ˆæ¯çš„æ–¹å¼ç§°ä¸º==å¾ªç¯æ³•==ã€‚
##### æ¶ˆæ¯ç¡®è®¤(message acknowledgments)
æˆ‘ä»¬ç°åœ¨å®Œæˆçš„ä»£ç å¯ä»¥åšåˆ°åˆ†å‘æ¶ˆæ¯ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªç¼ºé™·ï¼Œä¸€æ—¦RabbitMQå‘æ¶ˆå®¢æˆ·å‘é€æ¶ˆæ¯ï¼Œå®ƒå°†ç«‹å³å°†å…¶æ ‡è®°ä¸ºåˆ é™¤ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœä¸€ä¸ªworkeråœæ­¢å·¥ä½œäº†ï¼Œå°†ä¼šä¸¢å¤±å®ƒåˆšåˆšå¤„ç†çš„æ¶ˆæ¯ï¼Œè¿˜å°†ä¸¢å¤±åˆ†å‘ä½†å°šæœªå¤„ç†çš„æ‰€æœ‰ç»™è¿™ä¸ªç‰¹å®šworkerçš„æ¶ˆæ¯ã€‚
æ‰€ä»¥æˆ‘ä»¬åœ¨ä¸€ä¸ªworkeråœæ­¢å·¥ä½œçš„æ—¶å€™ï¼Œè¦åšå¥½å·¥ä½œäº¤æ¥ï¼Œç¡®ä¿ä¸ä¼šä¸¢å¤±ä»»ä½•æ¶ˆæ¯ã€‚
ä¸ºäº†ç¡®ä¿æ¶ˆæ¯æ°¸ä¸ä¸¢å¤±ï¼ŒRabbitMQæ”¯æŒæ¶ˆæ¯ç¡®è®¤ï¼Œæ¶ˆè´¹è€…è¿”å›==ack==(nowledgement)å‘Šè¯‰RabbitMQå·²æ”¶åˆ°ï¼Œå¤„ç†äº†è¿™æ¡æ¶ˆæ¯ï¼ŒRabbitMQå¯ä»¥è‡ªç”±åˆ é™¤å®ƒã€‚å¦‚æœæ¶ˆè´¹è€…æ­»äº¡ï¼ˆå…¶é€šé“å…³é—­ï¼Œè¿æ¥å…³é—­æˆ–è€…TCPè¿æ¥ä¸¢å¤±ï¼‰è€Œä¸èƒ½å‘é€å›æ‰§ï¼ŒRabbitMQå°†æœªå®Œå…¨å¤„ç†çš„æ¶ˆæ¯æ’é˜Ÿå¹¶é‡æ–°æ’é˜Ÿï¼Œå¦‚æœåŒæ—¶æœ‰å…¶ä»–åœ¨çº¿æ¶ˆè´¹è€…ï¼Œåˆ™ä¼šè¿…é€Ÿå°†å…¶é‡æ–°å‘é€ç»™å…¶ä»–æ¶ˆè´¹è€…ã€‚è¿™æ ·å°±å¯ä»¥ç¡®ä¿æ²¡æœ‰æ¶ˆæ¯ä¸¢å¤±ã€‚
æ¶ˆæ¯ä¸ä¼šè¶…æ—¶ï¼Œå½“æ¶ˆè´¹è€…æ­»äº¡æ—¶ï¼ŒRabbitMQå°†é‡æ–°å‘é€æ¶ˆæ¯ï¼Œå³ä½¿å¤„ç†æ¶ˆæ¯éœ€è¦éå¸¸é•¿çš„æ—¶é—´ï¼Œä¹Ÿæ²¡æœ‰å…³ç³»ã€‚
é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰‹åŠ¨æ¶ˆæ¯ç¡®è®¤å·²æ‰“å¼€ã€‚åœ¨å‰é¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡`no_ack = True`æ ‡å¿—æ˜ç¡®åœ°å°†å®ƒä»¬å…³é—­ã€‚åœ¨æˆ‘ä»¬å®Œæˆä»»åŠ¡åï¼Œæ˜¯æ—¶å€™åˆ é™¤æ­¤æ ‡å¿—å¹¶ä»å·¥ä½œäººå‘˜å‘é€é€‚å½“çš„ç¡®è®¤ã€‚
```
def callback(ch, method, properties, body):
    print " [x] Received %r" % (body,)
    time.sleep( body.count('.') )
    print " [x] Done"
    ch.basic_ack(delivery_tag = method.delivery_tag)#RabbitMQ will eat more and more memory as it won't be able to release any unacked messages if miss the basic_ack

channel.basic_consume(callback,
                      queue='hello')
```
ä½¿ç”¨è¿™ä»½ä»£ç ï¼Œå³ä½¿ä½¿ç”¨`CTRL+C`æ¥ç»ˆæ­¢workerçš„å·¥ä½œï¼Œä¹Ÿä¸ä¼šæœ‰ä»»ä½•çš„æ¶ˆæ¯ä¸¢å¤±ï¼Œæ²¡æœ‰å›æ‰§çš„æ¶ˆæ¯ä¼šè¢«é‡æ–°åˆ†é…ã€‚

#### æ¶ˆæ¯æŒä¹…æ€§
ç°åœ¨å³ä½¿æ¶ˆè´¹è€…æ­»äº¡ï¼Œæˆ‘ä»¬çš„ä»»åŠ¡ä¹Ÿä¸ä¼šä¸¢å¤±ï¼Œä½†æ˜¯å¦‚æœRabbitMQæœåŠ¡å™¨å®•æœºï¼Œæˆ‘ä»¬çš„ä»»åŠ¡ä»»ç„¶ä¼šä¸¢å¤±ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†æ¶ˆæ¯å’Œé˜Ÿåˆ—æ ‡è®°ä¸ºæŒä¹…ã€‚
é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿RabbitMQæ°¸è¿œä¸ä¼šä¸¢å¤±æˆ‘ä»¬çš„é˜Ÿåˆ—ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å£°æ˜å®ƒæ˜¯æŒä¹…çš„ï¼š
```
channel.queue_declareï¼ˆqueue = 'hello'ï¼Œdurable = Trueï¼‰
```
è™½ç„¶è¿™æ˜¯ä¸ªæ­£ç¡®çš„å‘½ä»¤ï¼Œä½†åœ¨æˆ‘ä»¬çš„è®¾ç½®ä¸­æ²¡æœ‰ç”¨ï¼Œé‚£æ˜¯å› ä¸ºæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªä¸è€ç”¨çš„`hello`é˜Ÿåˆ—ã€‚RabbitMQä¸å…è®¸ä½¿ç”¨ä¸åŒçš„å‚æ•°é‡æ–°å®šä¹‰ç°æœ‰é˜Ÿåˆ—ï¼Œå¹¶ä¸”ä¼šå‘å°è¯•æ‰§è¡Œæ­¤æ“ä½œçš„ä»»ä½•ç¨‹åºè¿”å›é”™è¯¯ã€‚æ‰€ä»¥è¿™é‡Œéœ€è¦å£°æ˜ä¸€ä¸ªå…·æœ‰ä¸åŒåç§°çš„é˜Ÿåˆ—ã€‚
```
channel.queue_declareï¼ˆqueue = 'task_queue'ï¼Œdurable = Trueï¼‰
```
æ­¤`queue_declare`æ›´æ”¹éœ€è¦åº”ç”¨äºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä»£ç ï¼Œæ­¤æ—¶æˆ‘ä»¬ç¡®ä¿¡å³ä½¿RabbitMQé‡æ–°å¯åŠ¨ï¼Œ`taks_queue`é˜Ÿåˆ—ä¹Ÿä¸ä¼šä¸¢å¤±ã€‚æˆ‘ä»¬éœ€è¦å°†æ¶ˆæ¯æ ‡è®°ä¸ºæŒä¹…æ€§--é€šè¿‡æä¾›å€¼ä¸º2çš„`delivery_mode`å±æ€§ã€‚
```
channel.basic_publishï¼ˆexchange = ''ï¼Œ
                      routing_key = â€œtask_queueâ€ï¼Œ
                      body = messageï¼Œ
                      properties = pika.BasicPropertiesï¼ˆ
                         delivery_mode = 2ï¼Œï¼ƒmake message persistent 
                      ï¼‰ï¼‰
```

æœ‰å…³æ¶ˆæ¯æŒä¹…æ€§:
å°†æ¶ˆæ¯æ ‡è®°ä¸ºæŒä¹…æ€§å¹¶ä¸èƒ½å®Œå…¨ä¿è¯æ¶ˆæ¯ä¸ä¼šä¸¢å¤±ã€‚è™½ç„¶å®ƒå‘Šè¯‰RabbitMQå°†æ¶ˆæ¯ä¿å­˜åˆ°ç£ç›˜ï¼Œä½†æ˜¯å½“RabbitMQæ¥å—æ¶ˆæ¯å¹¶ä¸”å°šæœªä¿å­˜æ¶ˆæ¯æ—¶ï¼Œä»ç„¶æœ‰ä¸€ä¸ªçŸ­æ—¶é—´çª—å£ã€‚æ­¤å¤–ï¼ŒRabbitMQä¸ä¼šä¸ºæ¯æ¡æ¶ˆæ¯æ‰§è¡Œfsyncï¼ˆ2ï¼‰ - å®ƒå¯èƒ½åªæ˜¯ä¿å­˜åˆ°ç¼“å­˜è€Œä¸æ˜¯çœŸæ­£å†™å…¥ç£ç›˜ã€‚æŒä¹…æ€§ä¿è¯ä¸å¼ºï¼Œä½†å¯¹äºæˆ‘ä»¬ç®€å•çš„ä»»åŠ¡é˜Ÿåˆ—æ¥è¯´å·²ç»è¶³å¤Ÿäº†ã€‚å¦‚æœæ‚¨éœ€è¦æ›´å¼ºçš„ä¿è¯ï¼Œé‚£ä¹ˆæ‚¨å¯ä»¥ä½¿ç”¨[å‘å¸ƒè€…ç¡®è®¤](https://www.rabbitmq.com/confirms.html).
##### å…¬å¹³æ´¾é£
å‡è®¾ç°åœ¨æœ‰ä¸¤ä¸ªå·¥äººï¼Œå¦‚æœæ€»æ˜¯ç»™ä¸€ä¸ªå·¥äººå‘é€ä»»åŠ¡ç¹é‡çš„å·¥ä½œï¼Œå°±ä¼šå¯¼è‡´ä¸€ä¸ªå·¥äººç»å¸¸å¿™ç¢Œï¼Œè€Œå¦ä¸€ä¸ªå·¥ä½œäººå‘˜å‡ ä¹ä¸ä¼šåšä»»ä½•å·¥ä½œï¼Œè€ŒRabbitMQå¯¹æ­¤ä¸€æ— æ‰€çŸ¥ï¼Œä»»ç„¶ä¼šå‡åŒ€å‘é€æ¶ˆæ¯ã€‚å‘ç”Ÿè¿™ç§æƒ…å†µæ˜¯å› ä¸ºRabbitMQåªæ˜¯åœ¨æ¶ˆæ¯è¿›å…¥é˜Ÿåˆ—æ—¶è°ƒåº¦æ¶ˆæ¯ï¼Œä»–ä¸ä¼šæŸ¥çœ‹æ¶ˆè´¹è€…æœªç¡®è®¤æ¶ˆæ¯çš„æ•°é‡ï¼Œåªæ˜¯ç›²ç›®åœ°å‘ç¬¬nä¸ªæ¶ˆè´¹è€…å‘é€ç¬¬nä¸ªæ¶ˆæ¯ã€‚
ï¼[](http://www.rabbitmq.com/img/tutorials/prefetch-count.png)

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`basic.qos`æ–¹æ³•å’Œ`prefetch_count=1`è®¾ç½®,è¿™æ„å‘³ç€åœ¨å¤„ç†å¹¶ç¡®è®¤å‰ä¸€ä¸ªæ¶ˆæ¯ä¹‹å‰ï¼Œä¸è¦å‘å·¥ä½œäººå‘˜å‘é€æ–°æ¶ˆæ¯ï¼Œç›¸åï¼Œä»–ä¼šå‘é€ç»™ä¸‹ä¸€ä¸ªä¾ç„¶å¿™ç¢Œçš„workerã€‚
å¦‚æœæ‰€æœ‰çš„workeréƒ½å¾ˆå¿™ï¼Œé˜Ÿåˆ—å°±ä¼šè¢«å¡«æ»¡ï¼Œå°½å¯èƒ½æ·»åŠ æ›´å¤šworkerï¼Œæˆ–è€…ä½¿ç”¨[æ¶ˆæ¯TTL](http://www.rabbitmq.com/ttl.html)
new_task.pyçš„æœ€ç»ˆä»£ç ï¼š

```
import pika
import sys

connection = pika.BlockingConnection(pika.ConnectionParameters(host='localhost'))
channel = connection.channel()

channel.queue_declare(queue='task_queue', durable=True)

message = ' '.join(sys.argv[1:]) or "Hello World!"
channel.basic_publish(exchange='',
                      routing_key='task_queue',
                      body=message,
                      properties=pika.BasicProperties(
                         delivery_mode = 2, # make message persistent
                      ))
print(" [x] Sent %r" % message)
connection.close()
```

Worker.pyçš„æœ€ç»ˆä»£ç ï¼š
```
import pika
import time

connection = pika.BlockingConnection(pika.ConnectionParameters(host='localhost'))
channel = connection.channel()

channel.queue_declare(queue='task_queue', durable=True)
print(' [*] Waiting for messages. To exit press CTRL+C')

def callback(ch, method, properties, body):
    print(" [x] Received %r" % body)
    time.sleep(body.count(b'.'))
    print(" [x] Done")
    ch.basic_ack(delivery_tag = method.delivery_tag)

channel.basic_qos(prefetch_count=1)
channel.basic_consume(callback,
                      queue='task_queue')

channel.start_consuming()
```
Â ä½¿ç”¨æ¶ˆæ¯ç¡®è®¤å’Œ`prefetch_couny`å¯ä»¥è®¾ç½®å·¥ä½œé˜Ÿåˆ—ï¼Œå³ä½¿RabbitMQé‡æ–°å¯åŠ¨ï¼ŒæŒä¹…æ€§é€‰é¡¹ä¹Ÿå¯ä»¥ä½¿ä»»åŠ¡ç”Ÿæ•ˆã€‚

